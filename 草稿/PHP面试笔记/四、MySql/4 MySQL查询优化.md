4 MySQL查询优化
===

### 面试题
请简述项目中如何优化SQL语句执行效率的方法，从哪个方便，SQL语句性能如何分析？
 
考点 
- 查找分析查询速度慢的原因
- 优化查询过程中的数据访问
- 优化常难的查询语句
- 优化特点类型的查询语句


### 分析查询慢的方法

#### 记录慢查询日志
- 开启慢查询日志
分析慢查询日志时，不要直接打开慢查询日志进行分析，这样比较浪费时间和精力，可以使用pt-query-digest	工具进行分析
- 使用show profiles
set profiling=1 开启，服务器上所有语句会检测消耗的时间存到临时表里。
- 使用show status
show status 会返回一些计数器，show global status 查看服务器级别的所有计数
有时候可以根据这些计数，可以猜测哪些操作代价较高或者消耗的时间太多
- show processlist
观察是否有大量的线程处于不正常的状态或是特征
- 使用explain 
explain select  分析单条语句，比较常用。explain 有个别名叫desc

### 优化方案
三大类：
- 访问数据太多导致查询性能下降
- 确定应用程序是否在检索大量超过需要的数据，可能是太多的行和列
- 确认MySQL是否在分析大量不必要的数据行

#### 避免使用以下SQL语句
- 查询不需要的记录，使用limit 解决
- 多表关联返回全部列，指定A.id ,B.age解决
- 总是取出全部列，select * 会让优化器无法完成对索引覆盖扫描优化。

- 重复查询相同的数据，可以缓存，下次直接读缓存
- 是否在扫描额外的数据，explain 发现扫描大部分数据，但只返回少数行，可以通过一项技巧解决
使用索引覆盖扫描，把所有的列都放在索引中，这样存储引擎不需要回表获取对应行就可以返回结果
改变数据库和表的结构，修改数据表范式

#### 优化长难的查询语句
- 一个复杂查询还是多个简单查询
- MySQL内部每秒能扫描内存中上百万行数据，相比之下，响应数据给客户端就要慢得多了。
- 使用尽可能少的查询是好的，但是有时将一个大的查询分解为多个小的查询是很有必要的。方便做缓存。

#### 切分查询
将一个大的查询切分为多个小的相同的查询
一次性删除1000万的数据要比一次删除1万，暂停一会的方案更加耗损服务器

#### 分解关联查询
可以将一条关联查询分解为多条语句进行查询，让缓存效率更高。
执行单个查询可以减少锁的竞争，在应用层做关联更容易对数据库进行拆分。

#### 优化特定类型的查询语句
- 优化count 查询
count(*)中的 * 会忽略所有列，直接统计所有的列数，因此不要使用count(列名)，使用count(*)更快
myisam中没有where语句的count(*)非常快，有where语句不一定比其他引擎快
- 优化关联查询
确定on 或者using字句的列上是否有索引
确保group by 和 order by中只有一个表的列，这样mysql才有可能用索引
- 优化子查询
尽量使用关联查询替代子查询
- 优化group by 和 distinct
这两种查询均可使用索引来优化，是最有效的优化方式。
关联查询中，使用标识列进行分组，效率更高
如果不需要order by ，进行group by 时使用 order by null ,mysql 就不会进行排序。效率更高。
WITH ROLLUP 超级聚合，可以挪到应用程序处理
- 优化limit分页
limit 偏移量大的时候，查询效率低
可以记录上一次查询的最大ID，下次查询时直接根据该ID来查询
- 优化 union 
union all 效率 高于 union


